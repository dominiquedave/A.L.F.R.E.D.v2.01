{% extends "base.html" %}

{% block content %}
<!-- Main Dashboard Header -->
<div class="dashboard-header">
    <h2 class="dashboard-title">
        <!-- <span class="title-icon">ğŸ¦‡</span> -->
        Bat Cave Command Center
        <!-- <span class="title-wings">ğŸ¦‡</span> -->
    </h2>
    <p class="dashboard-subtitle">
        Welcome to the darkness, where commands take flight
    </p>
</div>

<!-- Agent Status Grid -->
<div class="dashboard-grid">
    <!-- Agent Overview Card -->
    <div class="dashboard-card agent-overview">
        <div class="card-header">
            <h3 class="card-title">
                <img src="/static/logos/bat-silhouette-with-extended-wings-svgrepo-com.svg" class="card-icon" alt="bat" style="width: 1.9em; height: 1.9em; display: inline-block; vertical-align: middle;">
                Minion Status
            </h3>
        </div>
        <div class="card-content">
            <div class="agent-stats">
                <div class="stat-item healthy">
                    <div class="stat-value">{{ healthy_agents }}</div>
                    <div class="stat-label">Healthy Bats</div>
                </div>
                <div class="stat-divider">|</div>
                <div class="stat-item total">
                    <div class="stat-value">{{ total_agents }}</div>
                    <div class="stat-label">Total Colony</div>
                </div>
            </div>
            <div class="health-bar">
                <div class="health-fill" style="width: {% if total_agents > 0 %}{{ (healthy_agents / total_agents * 100)|round }}{% else %}0{% endif %}%"></div>
            </div>
        </div>
    </div>

    <!-- Voice Visualizer Card -->
    <div class="dashboard-card voice-visualizer-card">
        <div class="card-header">
            <h3 class="card-title">
                <img src="/static/logos/voice-recognition-svgrepo-com(1).svg" class="card-icon" alt="voice" style="width: 2.3em; height: 2.3em; display: inline-block; vertical-align: middle;">
                Voice Resonance
            </h3>
            <div class="visualizer-controls">
                <button id="mic-toggle" class="btn-visualizer" title="Toggle microphone input">
                    <span class="btn-icon">ğŸ¤</span>
                </button>
                <button id="visualizer-settings" class="btn-visualizer" title="Visualizer settings">
                    <span class="btn-icon">âš™ï¸</span>
                </button>
            </div>
        </div>
        <div class="card-content">
            <div class="visualizer-container">
                <canvas id="voice-visualizer" class="voice-canvas"></canvas>
                <div class="visualizer-status" id="visualizer-status">
                    <span class="status-indicator">
                        <span class="status-dot" id="audio-status-dot"></span>
                        <span id="audio-status-text">Idle</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Agent Details Grid -->
<div class="dashboard-section">
    <h3 class="section-title">
        <img src="/static/logos/phoenix-squadron-svgrepo-com(1).svg" class="section-icon" alt="squadron" style="width: 2em; height: 2em; display: inline-block; vertical-align: middle;">
        Colony Members
    </h3>

    {% if agents %}
    <div class="agents-grid">
        {% for agent in agents %}
        <div class="agent-card {{ 'healthy' if agent.is_healthy else 'unhealthy' }}">
            <div class="agent-header">
                <div class="agent-avatar">
                    {% if agent.os_type == 'Windows' %}ğŸªŸ
                    {% elif agent.os_type == 'Linux' %}ğŸ§
                    {% elif agent.os_type == 'Darwin' %}ğŸ
                    {% else %}ğŸ–¥ï¸
                    {% endif %}
                </div>
                <div class="agent-info">
                    <h4 class="agent-name">{{ agent.name }}</h4>
                    <p class="agent-id">{{ agent.id }}</p>
                </div>
                <div class="agent-status">
                    <span class="status-dot {{ 'pulse-green' if agent.is_healthy else 'pulse-red' }}"></span>
                </div>
            </div>
            <div class="agent-details">
                <div class="detail-row">
                    <span class="detail-label">OS:</span>
                    <span class="detail-value">{{ agent.os_type }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Location:</span>
                    <span class="detail-value">{{ agent.host }}:{{ agent.port }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Abilities:</span>
                    <span class="detail-value">{{ agent.capabilities|length }} skills</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Last Seen:</span>
                    <span class="detail-value">{{ agent.last_seen.strftime('%H:%M:%S') }}</span>
                </div>
            </div>
            <div class="agent-capabilities">
                {% for capability in agent.capabilities %}
                <span class="capability-tag">{{ capability }}</span>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <img src="/static/logos/bat-in-medium-size-variant-silhouette-svgrepo-com(1).svg" alt="No bats" style="width: 4em; height: 4em;">
        </div>
        <h3>No Bats in the Cave</h3>
        <p>Your colony appears to be empty. Click "Scan Territory" to discover available agents.</p>
        <button onclick="discoverAgents()" class="btn-primary">
            <img src="/static/logos/scan-2-svgrepo-com(1).svg" class="btn-icon" alt="scan" style="width: 2em; height: 2em; display: inline-block; vertical-align: middle;">
            Scan for Bats
        </button>
    </div>
    {% endif %}
</div>

<!-- Recent Commands -->
{% if recent_commands %}
<div class="dashboard-section">
    <h3 class="section-title">
        <span class="section-icon">ğŸ“œ</span>
        Recent Dark Deeds
    </h3>

    <div class="commands-history">
        {% for cmd in recent_commands %}
        <div class="history-item {{ 'success' if cmd.result.success else 'error' }}">
            <div class="history-header">
                <span class="history-time">{{ cmd.timestamp.split('T')[1].split('.')[0] }}</span>
                <span class="history-agent">{{ cmd.agent_used }}</span>
                <span class="history-status {{ 'success' if cmd.result.success else 'error' }}">
                    {{ 'âœ…' if cmd.result.success else 'âŒ' }}
                </span>
            </div>
            <div class="history-command">{{ cmd.user_input }}</div>
            {% if cmd.result.output %}
            <div class="history-output">{{ cmd.result.output[:100] }}{% if cmd.result.output|length > 100 %}...{% endif %}</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', path='/js/voice-visualizer.js') }}"></script>
<script src="{{ url_for('static', path='/js/voice-integration.js') }}"></script>
<script src="{{ url_for('static', path='/js/performance-monitor.js') }}"></script>
<script>
// Voice Visualizer Integration
let voiceVisualizer = null;

// Initialize visualizer when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    try {
        voiceVisualizer = new VoiceVisualizer('voice-visualizer', {
            segments: 64,
            primaryColor: '#00FFFF', // --bat-electric
            centerRadius: 25,
            maxRadius: 120
        });

        // Initialize performance monitoring
        if (window.PerformanceMonitor) {
            window.performanceMonitor = new PerformanceMonitor(voiceVisualizer);
        }

        console.log('ğŸ¦‡ Voice Visualizer integrated into dashboard');
    } catch (error) {
        console.error('ğŸ¦‡ Failed to initialize voice visualizer:', error);
    }

    setupVisualizerControls();
});

function setupVisualizerControls() {
    const micToggle = document.getElementById('mic-toggle');
    const statusDot = document.getElementById('audio-status-dot');
    const statusText = document.getElementById('audio-status-text');

    if (!micToggle || !voiceVisualizer) return;

    let micActive = false;

    micToggle.addEventListener('click', async function() {
        try {
            if (!micActive) {
                // Start microphone input
                const success = await voiceVisualizer.startMicrophoneInput();
                if (success) {
                    micActive = true;
                    micToggle.classList.add('active');
                    statusDot.classList.add('active');
                    statusText.textContent = 'Listening';

                    console.log('ğŸ¤ Microphone input started');
                } else {
                    updateStatus('error', 'Mic Failed');
                }
            } else {
                // Stop microphone input
                voiceVisualizer.stop();
                micActive = false;
                micToggle.classList.remove('active');
                statusDot.classList.remove('active', 'error');
                statusText.textContent = 'Idle';

                console.log('ğŸ”‡ Microphone input stopped');
            }
        } catch (error) {
            console.error('ğŸ¦‡ Microphone toggle error:', error);
            updateStatus('error', 'Audio Error');
        }
    });

    // Settings button with performance info
    const settingsBtn = document.getElementById('visualizer-settings');
    if (settingsBtn) {
        settingsBtn.addEventListener('click', function() {
            if (window.performanceMonitor) {
                window.performanceMonitor.logPerformanceReport();
            }
            console.log('ğŸ”§ Visualizer performance logged to console');
        });
    }
}

function updateStatus(state, text) {
    const statusDot = document.getElementById('audio-status-dot');
    const statusText = document.getElementById('audio-status-text');

    if (statusDot) {
        statusDot.classList.remove('active', 'error');
        if (state !== 'idle') {
            statusDot.classList.add(state);
        }
    }

    if (statusText) {
        statusText.textContent = text;
    }
}

// Integration with voice interface (if available)
function connectToVoiceInterface() {
    // This function can be called when voice interface is active
    // to connect the visualizer to AI voice output
    if (voiceVisualizer && window.speechSynthesis) {
        console.log('ğŸ¦‡ Attempting to connect to voice synthesis...');
        // TODO: Implement connection to voice synthesis audio stream
    }
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (voiceVisualizer) {
        voiceVisualizer.destroy();
    }
    if (window.performanceMonitor) {
        window.performanceMonitor.destroy();
    }
    if (window.voiceIntegration) {
        window.voiceIntegration.destroy();
    }
});

// Command form handling
document.getElementById('command-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const commandInput = document.getElementById('command-input');
    const command = commandInput.value.trim();

    if (!command) return;

    // Add command to output
    addToOutput(`ğŸ¦‡ $ ${command}`, 'command');
    addToOutput('ğŸŒ™ Executing in the shadows...', 'info');

    commandInput.value = '';
    commandInput.disabled = true;

    try {
        const formData = new FormData();
        formData.append('command', command);

        const response = await fetch('/execute', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            if (result.output) {
                addToOutput(result.output, 'success');
            }
            addToOutput(`âœ… Command completed in ${result.execution_time_ms}ms by ${result.agent_id}`, 'success');
        } else {
            addToOutput(`âŒ Command failed: ${result.error}`, 'error');
        }
    } catch (error) {
        addToOutput(`ğŸ’€ Network error: ${error.message}`, 'error');
    } finally {
        commandInput.disabled = false;
        commandInput.focus();
    }
});

function addToOutput(text, type) {
    const output = document.getElementById('command-output');
    const line = document.createElement('div');
    line.className = `output-line ${type}`;

    const prompt = document.createElement('span');
    prompt.className = 'output-prompt';
    prompt.textContent = type === 'command' ? 'ğŸ¦‡' :
                        type === 'success' ? 'âœ¨' :
                        type === 'error' ? 'ğŸ’€' : 'ğŸŒ™';

    const content = document.createElement('span');
    content.textContent = text;

    line.appendChild(prompt);
    line.appendChild(content);
    output.appendChild(line);

    // Scroll to bottom
    output.scrollTop = output.scrollHeight;

    // Limit output lines
    const lines = output.children;
    if (lines.length > 100) {
        output.removeChild(lines[1]); // Keep welcome message
    }
}

// Auto-focus command input
document.getElementById('command-input').focus();
</script>
{% endblock %}
