{% extends "base.html" %}

{% block content %}
<!-- Main Dashboard Header -->
<div class="dashboard-header">
    <h2 class="dashboard-title">
        <!-- <span class="title-icon">🦇</span> -->
        Bat Cave Command Center
        <!-- <span class="title-wings">🦇</span> -->
    </h2>
    <p class="dashboard-subtitle">
        Welcome to the darkness, where commands take flight
    </p>
</div>

<!-- Agent Status Grid -->
<div class="dashboard-grid">
    <!-- Agent Overview Card -->
    <div class="dashboard-card agent-overview">
        <div class="card-header">
            <h3 class="card-title">
                <img src="/static/logos/bat-silhouette-with-extended-wings-svgrepo-com.svg" class="card-icon" alt="bat" style="width: 1.9em; height: 1.9em; display: inline-block; vertical-align: middle;">
                Minion Status
            </h3>
        </div>
        <div class="card-content">
            <div class="agent-stats">
                <div class="stat-item healthy">
                    <div class="stat-value">{{ healthy_agents }}</div>
                    <div class="stat-label">Healthy Bats</div>
                </div>
                <div class="stat-divider">|</div>
                <div class="stat-item total">
                    <div class="stat-value">{{ total_agents }}</div>
                    <div class="stat-label">Total Colony</div>
                </div>
            </div>
            <div class="health-bar">
                <div class="health-fill" style="width: {% if total_agents > 0 %}{{ (healthy_agents / total_agents * 100)|round }}{% else %}0{% endif %}%"></div>
            </div>
        </div>
    </div>

    <!-- Command Terminal -->
    <div class="dashboard-card command-terminal">
        <div class="card-header">
            <h3 class="card-title">
                <span class="card-icon">⚡</span>
                Command Chamber
            </h3>
            <div class="terminal-controls">
                <span class="terminal-dot red"></span>
                <span class="terminal-dot yellow"></span>
                <span class="terminal-dot green"></span>
            </div>
        </div>
        <div class="card-content">
            <form id="command-form" class="command-form">
                <div class="input-group">
                    <span class="input-prompt">🦇 $</span>
                    <input type="text" 
                           id="command-input" 
                           name="command" 
                           placeholder="Enter your dark command..." 
                           class="command-input"
                           autocomplete="off">
                    <button type="submit" class="execute-btn">
                        <span class="btn-icon">🚀</span>
                        Execute
                    </button>
                </div>
            </form>
            <div id="command-output" class="command-output">
                <div class="output-line welcome">
                    <span class="output-prompt">🌙</span>
                    Welcome to the Bat Cave Terminal. Enter commands to control your digital empire.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Details Grid -->
<div class="dashboard-section">
    <h3 class="section-title">
        <span class="section-icon">👥</span>
        Colony Members
    </h3>
    
    {% if agents %}
    <div class="agents-grid">
        {% for agent in agents %}
        <div class="agent-card {{ 'healthy' if agent.is_healthy else 'unhealthy' }}">
            <div class="agent-header">
                <div class="agent-avatar">
                    {% if agent.os_type == 'Windows' %}🪟
                    {% elif agent.os_type == 'Linux' %}🐧
                    {% elif agent.os_type == 'Darwin' %}🍎
                    {% else %}🖥️
                    {% endif %}
                </div>
                <div class="agent-info">
                    <h4 class="agent-name">{{ agent.name }}</h4>
                    <p class="agent-id">{{ agent.id }}</p>
                </div>
                <div class="agent-status">
                    <span class="status-dot {{ 'pulse-green' if agent.is_healthy else 'pulse-red' }}"></span>
                </div>
            </div>
            <div class="agent-details">
                <div class="detail-row">
                    <span class="detail-label">OS:</span>
                    <span class="detail-value">{{ agent.os_type }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Location:</span>
                    <span class="detail-value">{{ agent.host }}:{{ agent.port }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Abilities:</span>
                    <span class="detail-value">{{ agent.capabilities|length }} skills</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Last Seen:</span>
                    <span class="detail-value">{{ agent.last_seen.strftime('%H:%M:%S') }}</span>
                </div>
            </div>
            <div class="agent-capabilities">
                {% for capability in agent.capabilities %}
                <span class="capability-tag">{{ capability }}</span>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">🦇</div>
        <h3>No Bats in the Cave</h3>
        <p>Your colony appears to be empty. Click "Scan Territory" to discover available agents.</p>
        <button onclick="discoverAgents()" class="btn-primary">
            <span class="btn-icon">🔍</span>
            Scan for Bats
        </button>
    </div>
    {% endif %}
</div>

<!-- Recent Commands -->
{% if recent_commands %}
<div class="dashboard-section">
    <h3 class="section-title">
        <span class="section-icon">📜</span>
        Recent Dark Deeds
    </h3>
    
    <div class="commands-history">
        {% for cmd in recent_commands %}
        <div class="history-item {{ 'success' if cmd.result.success else 'error' }}">
            <div class="history-header">
                <span class="history-time">{{ cmd.timestamp.split('T')[1].split('.')[0] }}</span>
                <span class="history-agent">{{ cmd.agent_used }}</span>
                <span class="history-status {{ 'success' if cmd.result.success else 'error' }}">
                    {{ '✅' if cmd.result.success else '❌' }}
                </span>
            </div>
            <div class="history-command">{{ cmd.user_input }}</div>
            {% if cmd.result.output %}
            <div class="history-output">{{ cmd.result.output[:100] }}{% if cmd.result.output|length > 100 %}...{% endif %}</div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
<script>
// Command form handling
document.getElementById('command-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const commandInput = document.getElementById('command-input');
    const command = commandInput.value.trim();
    
    if (!command) return;
    
    // Add command to output
    addToOutput(`🦇 $ ${command}`, 'command');
    addToOutput('🌙 Executing in the shadows...', 'info');
    
    commandInput.value = '';
    commandInput.disabled = true;
    
    try {
        const formData = new FormData();
        formData.append('command', command);
        
        const response = await fetch('/execute', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (result.output) {
                addToOutput(result.output, 'success');
            }
            addToOutput(`✅ Command completed in ${result.execution_time_ms}ms by ${result.agent_id}`, 'success');
        } else {
            addToOutput(`❌ Command failed: ${result.error}`, 'error');
        }
    } catch (error) {
        addToOutput(`💀 Network error: ${error.message}`, 'error');
    } finally {
        commandInput.disabled = false;
        commandInput.focus();
    }
});

function addToOutput(text, type) {
    const output = document.getElementById('command-output');
    const line = document.createElement('div');
    line.className = `output-line ${type}`;
    
    const prompt = document.createElement('span');
    prompt.className = 'output-prompt';
    prompt.textContent = type === 'command' ? '🦇' : 
                        type === 'success' ? '✨' : 
                        type === 'error' ? '💀' : '🌙';
    
    const content = document.createElement('span');
    content.textContent = text;
    
    line.appendChild(prompt);
    line.appendChild(content);
    output.appendChild(line);
    
    // Scroll to bottom
    output.scrollTop = output.scrollHeight;
    
    // Limit output lines
    const lines = output.children;
    if (lines.length > 100) {
        output.removeChild(lines[1]); // Keep welcome message
    }
}

// Auto-focus command input
document.getElementById('command-input').focus();
</script>
{% endblock %}